---
# yamllint disable-line rule:truthy
on:
  push:
    branches:
      - main
  workflow_dispatch:

name: Versioning
permissions:
  contents: read

concurrency:
  group: "${{ github.ref }}-${{ github.workflow }}"
  cancel-in-progress: true

jobs:
  versioning:
    runs-on: ubuntu-22.04
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # pin@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: calculate version
        id: calculate-version
        uses: bitshifted/git-auto-semver@f136eb2d08062ca75e92f2408e1e9ace385c7523 # pin@v1

      - name: Set version
        run: 'echo "VERSION_STRING=${{ steps.calculate-version.outputs.version-string }}" >> "$GITHUB_ENV"'

      - name: Generate release notes
        id: release-notes
        uses: RedCrafter07/release-notes-action@31674bfa3a219e7c661fc0c5b7b3851c741b9965 # pin@v1.0.1
        with:
          tag-name: "${{ steps.calculate-version.outputs.version-string }}"
          token: "${{ secrets.GITHUB_TOKEN }}"

      - name: Set release notes
        run: 'echo "RELEASE_NOTES=${{ steps.release-notes.outputs.release-notes }}" >> "$GITHUB_ENV"'

      - name: Create release
        id: create-release
        uses: softprops/action-gh-release@c95fe1489396fe8a9eb87c0abf8aa5b2ef267fda # pin@v2.2.1
        with:
          token: "${{ secrets.GITHUB_TOKEN }}"
          release_name: "${{ steps.calculate-version.outputs.version-string }}"
          body: "${{ steps.release-notes.outputs.release-notes }}"
          draft: false
          prerelease: false
